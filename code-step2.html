<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ­¥é©Ÿ 2ï¼šä¸»ç¨‹å¼ä»£ç¢¼ - AI å®¢æœç³»çµ±</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Microsoft JhengHei", sans-serif;
            background: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .back-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            text-decoration: none;
            font-size: 14px;
        }
        .back-btn:hover { background: rgba(255,255,255,0.3); }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 40px 20px;
        }
        .content {
            background: white;
            border-radius: 15px;
            padding: 40px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        h1 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 32px;
        }
        .instructions {
            background: #e7f3ff;
            border-left: 4px solid #2196f3;
            padding: 20px;
            margin: 20px 0;
            border-radius: 4px;
        }
        .instructions h3 {
            color: #2196f3;
            margin-bottom: 15px;
        }
        .instructions ol {
            margin-left: 20px;
        }
        .instructions li {
            margin-bottom: 8px;
        }
        .code-container {
            position: relative;
            margin: 30px 0;
        }
        .copy-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #28a745;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            z-index: 10;
        }
        .copy-btn:hover { background: #218838; }
        .copy-btn.copied { background: #667eea; }
        pre {
            background: #282c34;
            color: #abb2bf;
            padding: 60px 20px 20px 20px;
            border-radius: 10px;
            overflow-x: auto;
            font-family: "SF Mono", Monaco, Consolas, monospace;
            font-size: 13px;
            line-height: 1.6;
            max-height: 600px;
        }
        code {
            color: #abb2bf;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <div><h2 style="margin: 0; font-size: 20px;">ğŸ¤– AI å®¢æœç³»çµ± - æ­¥é©Ÿ 2ï¼šä¸»ç¨‹å¼ä»£ç¢¼</h2></div>
            <a href="home.html" class="back-btn">â† è¿”å›é¦–é </a>
        </div>
    </div>
    
    <div class="container">
        <div class="content">
            <h1>æ­¥é©Ÿ 2ï¼šä¸»ç¨‹å¼ä»£ç¢¼</h1>
            
            <div class="instructions">
                <h3>ğŸ“‹ æ“ä½œèªªæ˜ï¼š</h3>
                <ol>
                    <li>ç¢ºèªæ­¥é©Ÿ 1 å·²å®Œæˆï¼ˆ6 å€‹åˆ†é å·²å»ºç«‹ï¼‰</li>
<li>åœ¨ Apps Script ä¸­ï¼Œåˆªé™¤é è¨­çš„ Code.gs</li>
<li>å»ºç«‹æ–°æª”æ¡ˆï¼Œå‘½åï¼šAIå®¢æœç³»çµ±</li>
<li>æŠŠä¸‹é¢ä»£ç¢¼<strong>å…¨é¸è¤‡è£½</strong>ï¼Œè²¼åˆ° Apps Script</li>
<li>âš ï¸ <strong>ä¿®æ”¹ç¬¬ 18-40 è¡Œçš„ CONFIG è¨­å®š</strong>ï¼ˆé‡è¦ï¼ï¼‰</li>
<li>é»æ“Šã€Œå„²å­˜ã€</li>
<li>é€²è¡Œæ­¥é©Ÿ 3ï¼ˆéƒ¨ç½²ç‚º Web Appï¼‰</li>
                </ol>
            </div>
            
            <div class="code-container">
                <button class="copy-btn" onclick="copyCode()">ğŸ“‹ è¤‡è£½ä»£ç¢¼</button>
                <pre id="codeBlock"><code>// ==================== æ­¥é©Ÿ 2ï¼šéƒ¨ç½²ä¸»ç¨‹å¼ ====================
//
// æ“ä½œèªªæ˜ï¼š
// 1. ç¢ºèªæ­¥é©Ÿ 1 å·²å®Œæˆï¼ˆ6 å€‹åˆ†é å·²å»ºç«‹ï¼‰
// 2. åœ¨ Apps Script ä¸­ï¼Œåˆªé™¤é è¨­çš„ Code.gs
// 3. å»ºç«‹æ–°æª”æ¡ˆï¼Œå‘½åï¼šAIå®¢æœç³»çµ±
// 4. æŠŠä¸‹é¢æ•´æ®µä»£ç¢¼è¤‡è£½è²¼ä¸Š
// 5. **ä¿®æ”¹ç¬¬ 18-30 è¡Œçš„ CONFIG è¨­å®š**ï¼ˆé‡è¦ï¼ï¼‰
// 6. é»æ“Šã€Œå„²å­˜ã€
// 7. é€²è¡Œæ­¥é©Ÿ 3ï¼ˆéƒ¨ç½²ç‚º Web Appï¼‰
//
// âš ï¸ éœ€è¦ä¿®æ”¹çš„åœ°æ–¹ï¼ˆæœå°‹ YOUR_ é–‹é ­çš„å€¼ï¼‰ï¼š
// - LINE_CHANNEL_ACCESS_TOKENï¼šå¾ LINE Developers å–å¾—
// - SPREADSHEET_IDï¼šå¾ç¶²å€å–å¾—ï¼ˆ/d/ å’Œ /edit ä¹‹é–“çš„é‚£ä¸²ï¼‰
// - OPENAI_API_KEYï¼šå¾ OpenAI Platform å–å¾—
// - ADMIN_USERSï¼šå¡«å…¥æ‚¨çš„ LINE User IDï¼ˆå…ˆç•™ç©ºï¼Œç¨å¾Œå¡«ï¼‰
//
// ========================================================================

/*
 * ONEæ¡ŒéŠ AI å®¢æœç³»çµ± - å®Œæ•´ç‰ˆ
 * ç‰ˆæœ¬ï¼šv3.0
 * æ—¥æœŸï¼š2026-02-18
 */

// ==================== å…¨åŸŸè¨­å®šï¼ˆâš ï¸ è«‹ä¿®æ”¹é€™è£¡ï¼‰====================
const CONFIG = {
  // LINE Bot è¨­å®š
  CHANNEL_ACCESS_TOKEN: &#x27;YOUR_LINE_CHANNEL_ACCESS_TOKEN&#x27;, // â† ä¿®æ”¹é€™è£¡
  
  // Google Sheets è¨­å®š
  SPREADSHEET_ID: &#x27;YOUR_SPREADSHEET_ID&#x27;, // â† ä¿®æ”¹é€™è£¡ï¼ˆå¾ç¶²å€è¤‡è£½ï¼‰
  
  // AI API è¨­å®šï¼ˆæ“‡ä¸€ä½¿ç”¨ï¼‰
  AI_PROVIDER: &#x27;openai&#x27;, // ä½¿ç”¨ OpenAI å°±å¡« &#x27;openai&#x27;ï¼Œä½¿ç”¨ Claude å°±å¡« &#x27;claude&#x27;
  OPENAI_API_KEY: &#x27;YOUR_OPENAI_API_KEY&#x27;, // â† ä¿®æ”¹é€™è£¡
  CLAUDE_API_KEY: &#x27;&#x27;, // å¦‚æœç”¨ Claude æ‰å¡«
  
  // AI é è¨­åƒæ•¸
  AI_MODEL: &#x27;gpt-4-turbo-preview&#x27;, // OpenAI æ¨¡å‹åç¨±
  AI_MAX_TOKENS: 500,
  AI_TEMPERATURE: 0.7,
  
  // ç³»çµ±è¨­å®š
  DEFAULT_AI_MUTE_MINUTES: 10, // å®¢äººè½‰çœŸäººé è¨­ç¦è¨€æ™‚é–“
  MAX_CONTEXT_MESSAGES: 10, // AI è¨˜æ†¶æœ€è¿‘ N å‰‡å°è©±
  
  // æ¬Šé™è¨­å®šï¼ˆLINE User IDï¼‰
  ADMIN_USERS: [], // â† ç¨å¾Œå¡«å…¥æ‚¨çš„ LINE User ID
  MERCHANT_USERS: [] // å•†å®¶ç®¡ç†å“¡ï¼ˆå¾ Sheets è®€å–ï¼‰
};

// ==================== LINE Webhook ä¸»å‡½æ•¸ ====================
function doPost(e) {
  try {
    const event = JSON.parse(e.postData.contents).events[0];
    
    // åªè™•ç†æ–‡å­—è¨Šæ¯
    if (event.type !== &#x27;message&#x27; || event.message.type !== &#x27;text&#x27;) {
      return ContentService.createTextOutput(JSON.stringify({status: &#x27;ok&#x27;}));
    }
    
    const userId = event.source.userId;
    const userMessage = event.message.text.trim();
    const replyToken = event.replyToken;
    
    // åˆ¤æ–·ç”¨æˆ¶è§’è‰²
    const userRole = getUserRole(userId);
    
    // å•†å®¶æŒ‡ä»¤è™•ç†
    if (userRole === &#x27;merchant&#x27; || userRole === &#x27;admin&#x27;) {
      if (userMessage.startsWith(&#x27;/&#x27;)) {
        handleMerchantCommand(userId, userMessage, replyToken);
        return ContentService.createTextOutput(JSON.stringify({status: &#x27;ok&#x27;}));
      }
    }
    
    // å®¢äººæŒ‡ä»¤è™•ç†
    if (userMessage === &#x27;è½‰çœŸäºº&#x27; || userMessage.includes(&#x27;çœŸäºº&#x27;)) {
      handleTransferToHuman(userId, replyToken);
      return ContentService.createTextOutput(JSON.stringify({status: &#x27;ok&#x27;}));
    }
    
    // æª¢æŸ¥ AI æ˜¯å¦è¢«ç¦è¨€
    const aiStatus = getAIStatus(userId);
    if (!aiStatus.enabled) {
      // AI è¢«ç¦è¨€ï¼Œä¸å›æ‡‰
      logConversation(userId, userMessage, &#x27;[AI å·²ç¦è¨€]&#x27;, &#x27;muted&#x27;);
      return ContentService.createTextOutput(JSON.stringify({status: &#x27;ok&#x27;}));
    }
    
    // AI è‡ªå‹•å›æ‡‰
    handleAIResponse(userId, userMessage, replyToken);
    
    return ContentService.createTextOutput(JSON.stringify({status: &#x27;ok&#x27;}));
    
  } catch (error) {
    logError(&#x27;doPost&#x27;, error);
    return ContentService.createTextOutput(JSON.stringify({status: &#x27;error&#x27;, message: error.toString()}));
  }
}

// ==================== æ¬Šé™ç®¡ç† ====================
function getUserRole(userId) {
  // æª¢æŸ¥æ˜¯å¦ç‚ºç¸½éƒ¨ç®¡ç†å“¡
  if (CONFIG.ADMIN_USERS.includes(userId)) {
    return &#x27;admin&#x27;;
  }
  
  // æª¢æŸ¥æ˜¯å¦ç‚ºå•†å®¶ç®¡ç†å“¡ï¼ˆå¾ Sheets è®€å–ï¼‰
  const ss = SpreadsheetApp.openById(CONFIG.SPREADSHEET_ID);
  const merchantSheet = ss.getSheetByName(&#x27;å•†å®¶è¨­å®š&#x27;);
  const merchantData = merchantSheet.getDataRange().getValues();
  
  for (let i = 1; i &lt; merchantData.length; i++) {
    const merchantUserId = merchantData[i][5]; // ç¬¬ 6 æ¬„æ˜¯ LINE User ID
    if (merchantUserId === userId) {
      return &#x27;merchant&#x27;;
    }
  }
  
  // é è¨­ç‚ºå®¢äºº
  return &#x27;customer&#x27;;
}

// ==================== å•†å®¶æŒ‡ä»¤ç³»çµ± ====================
function handleMerchantCommand(userId, command, replyToken) {
  const parts = command.split(&#x27; &#x27;);
  const cmd = parts[0].toLowerCase();
  const targetUserId = parts[1]; // å®¢äººçš„ User ID
  const param = parts[2]; // é¡å¤–åƒæ•¸ï¼ˆæ™‚é–“/è¨Šæ¯ï¼‰
  
  let response = &#x27;&#x27;;
  
  switch(cmd) {
    case &#x27;/aiç‹€æ…‹&#x27;:
    case &#x27;/aistatus&#x27;:
      response = getAIStatusMessage(targetUserId);
      break;
      
    case &#x27;/aié—œé–‰&#x27;:
    case &#x27;/aimute&#x27;:
      const muteMinutes = param ? parseInt(param) : CONFIG.DEFAULT_AI_MUTE_MINUTES;
      response = muteAI(targetUserId, muteMinutes);
      notifyCustomer(targetUserId, &#x27;åº—é•·å°‡ç‚ºæ‚¨æä¾›äººå·¥æœå‹™ ğŸ™‹\nAI å°å¹«æ‰‹å·²æš«æ™‚é—œé–‰ã€‚&#x27;);
      break;
      
    case &#x27;/aié–‹å•Ÿ&#x27;:
    case &#x27;/aienable&#x27;:
      response = enableAI(targetUserId);
      notifyCustomer(targetUserId, &#x27;AI å°å¹«æ‰‹å·²æ¢å¾©æœå‹™ ğŸ¤–\næœ‰ä»»ä½•å•é¡Œéƒ½å¯ä»¥å•æˆ‘å–”ï¼&#x27;);
      break;
      
    case &#x27;/aiä¸»å‹•&#x27;:
    case &#x27;/aisend&#x27;:
      const message = parts.slice(2).join(&#x27; &#x27;); // å–å¾—å®Œæ•´è¨Šæ¯
      if (message) {
        response = sendAIMessage(targetUserId, message);
      } else {
        response = &#x27;âŒ è«‹æä¾›è¦ç™¼é€çš„è¨Šæ¯å…§å®¹\nç¯„ä¾‹ï¼š/aiä¸»å‹• U123... æ‚¨å¥½ï¼Œè«‹å•éœ€è¦å”åŠ©å—ï¼Ÿ&#x27;;
      }
      break;
      
    case &#x27;/aiæ¸…å–®&#x27;:
    case &#x27;/ailist&#x27;:
      response = getMutedCustomersList();
      break;
      
    case &#x27;/help&#x27;:
    case &#x27;/æŒ‡ä»¤&#x27;:
      response = getMerchantCommandHelp();
      break;
      
    default:
      response = &#x27;âŒ æœªçŸ¥æŒ‡ä»¤ï¼Œè«‹è¼¸å…¥ /help æŸ¥çœ‹å¯ç”¨æŒ‡ä»¤&#x27;;
  }
  
  // å›è¦†å•†å®¶
  replyMessage(replyToken, response);
  
  // è¨˜éŒ„å•†å®¶æ“ä½œ
  logMerchantAction(userId, command, response);
}

// ==================== AI ç‹€æ…‹ç®¡ç† ====================
function getAIStatus(userId) {
  const ss = SpreadsheetApp.openById(CONFIG.SPREADSHEET_ID);
  let statusSheet = ss.getSheetByName(&#x27;æœƒå“¡ç‹€æ…‹&#x27;);
  
  if (!statusSheet) {
    // å¦‚æœåˆ†é ä¸å­˜åœ¨ï¼Œå‰µå»ºå®ƒ
    statusSheet = createMemberStatusSheet();
  }
  
  const data = statusSheet.getDataRange().getValues();
  
  for (let i = 1; i &lt; data.length; i++) {
    if (data[i][0] === userId) {
      const aiEnabled = data[i][1]; // ç¬¬ 2 æ¬„ï¼šAI ç‹€æ…‹ï¼ˆTRUE/FALSEï¼‰
      const mutedUntil = data[i][2]; // ç¬¬ 3 æ¬„ï¼šç¦è¨€åˆ°æœŸæ™‚é–“
      
      // æª¢æŸ¥ç¦è¨€æ™‚é–“æ˜¯å¦å·²éæœŸ
      if (mutedUntil &amp;&amp; new Date() &gt; new Date(mutedUntil)) {
        // è‡ªå‹•è§£é™¤ç¦è¨€
        statusSheet.getRange(i + 1, 2, 1, 2).setValues([[true, &#x27;&#x27;]]);
        return { enabled: true, mutedUntil: null };
      }
      
      return { enabled: aiEnabled, mutedUntil: mutedUntil };
    }
  }
  
  // æ–°å®¢äººï¼Œé è¨­é–‹å•Ÿ AI
  statusSheet.appendRow([userId, true, &#x27;&#x27;, new Date()]);
  return { enabled: true, mutedUntil: null };
}

function muteAI(userId, minutes) {
  const ss = SpreadsheetApp.openById(CONFIG.SPREADSHEET_ID);
  const statusSheet = ss.getSheetByName(&#x27;æœƒå“¡ç‹€æ…‹&#x27;);
  const data = statusSheet.getDataRange().getValues();
  
  const mutedUntil = new Date(Date.now() + minutes * 60 * 1000);
  
  for (let i = 1; i &lt; data.length; i++) {
    if (data[i][0] === userId) {
      statusSheet.getRange(i + 1, 2, 1, 2).setValues([[false, mutedUntil]]);
      return `âœ… AI å·²é—œé–‰ ${minutes} åˆ†é˜\nåˆ°æœŸæ™‚é–“ï¼š${formatDateTime(mutedUntil)}`;
    }
  }
  
  // æ–°å¢è¨˜éŒ„
  statusSheet.appendRow([userId, false, mutedUntil, new Date()]);
  return `âœ… AI å·²é—œé–‰ ${minutes} åˆ†é˜\nåˆ°æœŸæ™‚é–“ï¼š${formatDateTime(mutedUntil)}`;
}

function enableAI(userId) {
  const ss = SpreadsheetApp.openById(CONFIG.SPREADSHEET_ID);
  const statusSheet = ss.getSheetByName(&#x27;æœƒå“¡ç‹€æ…‹&#x27;);
  const data = statusSheet.getDataRange().getValues();
  
  for (let i = 1; i &lt; data.length; i++) {
    if (data[i][0] === userId) {
      statusSheet.getRange(i + 1, 2, 1, 2).setValues([[true, &#x27;&#x27;]]);
      return &#x27;âœ… AI å·²é–‹å•Ÿï¼Œå°‡è‡ªå‹•å›æ‡‰å®¢äººè¨Šæ¯&#x27;;
    }
  }
  
  // æ–°å¢è¨˜éŒ„
  statusSheet.appendRow([userId, true, &#x27;&#x27;, new Date()]);
  return &#x27;âœ… AI å·²é–‹å•Ÿï¼Œå°‡è‡ªå‹•å›æ‡‰å®¢äººè¨Šæ¯&#x27;;
}

function getAIStatusMessage(targetUserId) {
  const status = getAIStatus(targetUserId);
  
  if (status.enabled) {
    return `ğŸ¤– AI ç‹€æ…‹ï¼šé–‹å•Ÿ\nå°‡è‡ªå‹•å›æ‡‰å®¢äººè¨Šæ¯`;
  } else {
    return `ğŸ”‡ AI ç‹€æ…‹ï¼šé—œé–‰\nåˆ°æœŸæ™‚é–“ï¼š${formatDateTime(status.mutedUntil)}`;
  }
}

function getMutedCustomersList() {
  const ss = SpreadsheetApp.openById(CONFIG.SPREADSHEET_ID);
  const statusSheet = ss.getSheetByName(&#x27;æœƒå“¡ç‹€æ…‹&#x27;);
  const data = statusSheet.getDataRange().getValues();
  
  let mutedList = &#x27;ğŸ”‡ ç›®å‰è¢«ç¦è¨€çš„å®¢äººï¼š\n\n&#x27;;
  let count = 0;
  
  for (let i = 1; i &lt; data.length; i++) {
    if (!data[i][1] &amp;&amp; data[i][2]) { // AI é—œé–‰ä¸”æœ‰åˆ°æœŸæ™‚é–“
      const userId = data[i][0];
      const mutedUntil = data[i][2];
      
      // æª¢æŸ¥æ˜¯å¦å·²éæœŸ
      if (new Date() &lt; new Date(mutedUntil)) {
        count++;
        mutedList += `${count}. ${userId.substring(0, 10)}...\n`;
        mutedList += `   åˆ°æœŸï¼š${formatDateTime(mutedUntil)}\n\n`;
      }
    }
  }
  
  if (count === 0) {
    return &#x27;âœ… ç›®å‰æ²’æœ‰è¢«ç¦è¨€çš„å®¢äºº&#x27;;
  }
  
  return mutedList;
}

// ==================== AI å›æ‡‰è™•ç† ====================
function handleAIResponse(userId, userMessage, replyToken) {
  try {
    // è®€å–å•†å®¶è¨­å®šï¼ˆAI å€‹æ€§ã€è¦å‰‡ç­‰ï¼‰
    const merchantConfig = getMerchantConfig(userId);
    
    // è®€å–å°è©±æ­·å²ï¼ˆæœ€è¿‘ N å‰‡ï¼‰
    const conversationHistory = getConversationHistory(userId, CONFIG.MAX_CONTEXT_MESSAGES);
    
    // å»ºç«‹ AI æç¤ºè©
    const systemPrompt = buildSystemPrompt(merchantConfig);
    
    // å‘¼å« AI API
    let aiResponse;
    if (CONFIG.AI_PROVIDER === &#x27;openai&#x27;) {
      aiResponse = callOpenAI(systemPrompt, conversationHistory, userMessage);
    } else {
      aiResponse = callClaude(systemPrompt, conversationHistory, userMessage);
    }
    
    // å›è¦†å®¢äºº
    replyMessage(replyToken, aiResponse);
    
    // è¨˜éŒ„å°è©±
    logConversation(userId, userMessage, aiResponse, &#x27;ai_response&#x27;);
    
  } catch (error) {
    logError(&#x27;handleAIResponse&#x27;, error);
    replyMessage(replyToken, &#x27;æŠ±æ­‰ï¼Œç³»çµ±æš«æ™‚ç„¡æ³•å›æ‡‰ï¼Œè«‹ç¨å¾Œå†è©¦æˆ–è¼¸å…¥ã€Œè½‰çœŸäººã€å°‹æ±‚äººå·¥å”åŠ©ã€‚&#x27;);
  }
}

function buildSystemPrompt(merchantConfig) {
  let prompt = `ä½ æ˜¯ ${merchantConfig.aiName || &#x27;ONEæ¡ŒéŠ AI å®¢æœ&#x27;}ï¼Œ`;
  prompt += `å€‹æ€§ï¼š${merchantConfig.aiPersonality || &#x27;å°ˆæ¥­ã€å‹å–„ã€è€å¿ƒ&#x27;}ã€‚\n\n`;
  
  prompt += `## æ ¸å¿ƒè¦å‰‡\n`;
  prompt += `1. é€™æ˜¯ç„¡äººè‡ªåŠ©åº—ï¼Œçµ•å°ä¸å¯æåŠã€Œç¾å ´äººå“¡ã€ã€Œåº—å“¡ã€ã€Œæ«ƒå°ã€\n`;
  prompt += `2. æ‰€æœ‰å•é¡Œéƒ½ä»¥ã€Œé ç«¯å”åŠ©ã€ã€ŒLINE å®¢æœã€ã€Œè¦–è¨Šæ”¯æ´ã€è§£æ±º\n`;
  prompt += `3. é‡åˆ°ç„¡æ³•è™•ç†çš„å•é¡Œï¼Œå¼•å°å®¢äººã€Œå‘¼å«æ”¯æ´ã€\n`;
  prompt += `4. å›è¦†å­—æ•¸é™åˆ¶ï¼š${merchantConfig.maxWords || 100} å­—ä»¥å…§\n\n`;
  
  prompt += `## åº—å®¶è³‡è¨Š\n`;
  prompt += `- å•†å®¶åç¨±ï¼š${merchantConfig.merchantName}\n`;
  prompt += `- å®¢æœé›»è©±ï¼š${merchantConfig.phone}\n`;
  prompt += `- å®¢æœæ™‚é–“ï¼š${merchantConfig.serviceHours}\n`;
  prompt += `- é ç´„ç¶²å€ï¼š${merchantConfig.bookingUrl}\n\n`;
  
  // åŠ å…¥è‡ªè¨‚è¦å‰‡
  if (merchantConfig.customRules) {
    prompt += `## ç‰¹æ®Šè¦å‰‡\n${merchantConfig.customRules}\n\n`;
  }
  
  prompt += `è«‹æ ¹æ“šä»¥ä¸Šè¨­å®šï¼Œå°ˆæ¥­ä¸”å‹å–„åœ°å›ç­”å®¢äººå•é¡Œã€‚`;
  
  return prompt;
}

// ==================== OpenAI API ====================
function callOpenAI(systemPrompt, conversationHistory, userMessage) {
  const messages = [
    { role: &#x27;system&#x27;, content: systemPrompt }
  ];
  
  // åŠ å…¥å°è©±æ­·å²
  conversationHistory.forEach(msg =&gt; {
    messages.push({ role: &#x27;user&#x27;, content: msg.userMessage });
    messages.push({ role: &#x27;assistant&#x27;, content: msg.aiResponse });
  });
  
  // åŠ å…¥ç•¶å‰è¨Šæ¯
  messages.push({ role: &#x27;user&#x27;, content: userMessage });
  
  const payload = {
    model: CONFIG.AI_MODEL,
    messages: messages,
    max_tokens: CONFIG.AI_MAX_TOKENS,
    temperature: CONFIG.AI_TEMPERATURE
  };
  
  const options = {
    method: &#x27;post&#x27;,
    headers: {
      &#x27;Authorization&#x27;: &#x27;Bearer &#x27; + CONFIG.OPENAI_API_KEY,
      &#x27;Content-Type&#x27;: &#x27;application/json&#x27;
    },
    payload: JSON.stringify(payload),
    muteHttpExceptions: true
  };
  
  const response = UrlFetchApp.fetch(&#x27;https://api.openai.com/v1/chat/completions&#x27;, options);
  const result = JSON.parse(response.getContentText());
  
  if (result.error) {
    throw new Error(&#x27;OpenAI API Error: &#x27; + result.error.message);
  }
  
  return result.choices[0].message.content.trim();
}

// ==================== Claude API ====================
function callClaude(systemPrompt, conversationHistory, userMessage) {
  const messages = [];
  
  // åŠ å…¥å°è©±æ­·å²
  conversationHistory.forEach(msg =&gt; {
    messages.push({ role: &#x27;user&#x27;, content: msg.userMessage });
    messages.push({ role: &#x27;assistant&#x27;, content: msg.aiResponse });
  });
  
  // åŠ å…¥ç•¶å‰è¨Šæ¯
  messages.push({ role: &#x27;user&#x27;, content: userMessage });
  
  const payload = {
    model: CONFIG.AI_MODEL,
    max_tokens: CONFIG.AI_MAX_TOKENS,
    temperature: CONFIG.AI_TEMPERATURE,
    system: systemPrompt,
    messages: messages
  };
  
  const options = {
    method: &#x27;post&#x27;,
    headers: {
      &#x27;x-api-key&#x27;: CONFIG.CLAUDE_API_KEY,
      &#x27;anthropic-version&#x27;: &#x27;2023-06-01&#x27;,
      &#x27;Content-Type&#x27;: &#x27;application/json&#x27;
    },
    payload: JSON.stringify(payload),
    muteHttpExceptions: true
  };
  
  const response = UrlFetchApp.fetch(&#x27;https://api.anthropic.com/v1/messages&#x27;, options);
  const result = JSON.parse(response.getContentText());
  
  if (result.error) {
    throw new Error(&#x27;Claude API Error: &#x27; + result.error.message);
  }
  
  return result.content[0].text.trim();
}

// ==================== è®€å–å•†å®¶è¨­å®š ====================
function getMerchantConfig(userId) {
  const ss = SpreadsheetApp.openById(CONFIG.SPREADSHEET_ID);
  const configSheet = ss.getSheetByName(&#x27;åŸºç¤è¨­ç½®&#x27;);
  
  // ç°¡åŒ–ç‰ˆï¼šå‡è¨­åªæœ‰ä¸€å€‹å•†å®¶ï¼Œå¯¦éš›æ‡‰æ ¹æ“š userId åˆ¤æ–·å±¬æ–¼å“ªå€‹å•†å®¶
  const data = configSheet.getDataRange().getValues();
  
  const config = {
    merchantName: data[1][1] || &#x27;ONEæ¡ŒéŠ&#x27;,
    phone: data[2][1] || &#x27;0900-000-000&#x27;,
    serviceHours: data[3][1] || &#x27;24å°æ™‚&#x27;,
    bookingUrl: data[4][1] || &#x27;https://example.com&#x27;,
    aiName: data[5][1] || &#x27;AI å°å¹«æ‰‹&#x27;,
    aiPersonality: data[6][1] || &#x27;å°ˆæ¥­ã€å‹å–„ã€è€å¿ƒ&#x27;,
    maxWords: parseInt(data[7][1]) || 100,
    customRules: data[8][1] || &#x27;&#x27;
  };
  
  return config;
}

// ==================== å°è©±æ­·å² ====================
function getConversationHistory(userId, limit) {
  const ss = SpreadsheetApp.openById(CONFIG.SPREADSHEET_ID);
  let logSheet = ss.getSheetByName(&#x27;å°è©±ç´€éŒ„&#x27;);
  
  if (!logSheet) {
    logSheet = createConversationLogSheet();
    return [];
  }
  
  const data = logSheet.getDataRange().getValues();
  const userConversations = [];
  
  // å€’åºæŸ¥æ‰¾è©²ç”¨æˆ¶çš„å°è©±ï¼ˆæœ€æ–°åœ¨å‰ï¼‰
  for (let i = data.length - 1; i &gt;= 1; i--) {
    if (data[i][1] === userId &amp;&amp; data[i][4] === &#x27;ai_response&#x27;) {
      userConversations.push({
        userMessage: data[i][2],
        aiResponse: data[i][3]
      });
      
      if (userConversations.length &gt;= limit) {
        break;
      }
    }
  }
  
  // åè½‰é †åºï¼ˆæœ€èˆŠåœ¨å‰ï¼‰
  return userConversations.reverse();
}

function logConversation(userId, userMessage, aiResponse, type) {
  const ss = SpreadsheetApp.openById(CONFIG.SPREADSHEET_ID);
  let logSheet = ss.getSheetByName(&#x27;å°è©±ç´€éŒ„&#x27;);
  
  if (!logSheet) {
    logSheet = createConversationLogSheet();
  }
  
  logSheet.appendRow([
    new Date(),
    userId,
    userMessage,
    aiResponse,
    type
  ]);
}

// ==================== å®¢äººè½‰çœŸäºº ====================
function handleTransferToHuman(userId, replyToken) {
  // ç¦è¨€ AI
  muteAI(userId, CONFIG.DEFAULT_AI_MUTE_MINUTES);
  
  // é€šçŸ¥å®¢äºº
  const message = `âœ… å·²ç‚ºæ‚¨è½‰æ¥çœŸäººå®¢æœ\n\n` +
                  `AI å°å¹«æ‰‹å°‡æš«åœ ${CONFIG.DEFAULT_AI_MUTE_MINUTES} åˆ†é˜\n` +
                  `å®¢æœäººå“¡æœƒç›¡å¿«å›è¦†æ‚¨ ğŸ™‹`;
  
  replyMessage(replyToken, message);
  
  // é€šçŸ¥å•†å®¶ï¼ˆæ¨æ’­ï¼‰
  notifyMerchant(`ğŸ”” å®¢äººè¦æ±‚è½‰çœŸäºº\n\nUser ID: ${userId}\nè«‹ç›¡å¿«è™•ç†`);
  
  // è¨˜éŒ„
  logConversation(userId, &#x27;è½‰çœŸäºº&#x27;, message, &#x27;transfer_to_human&#x27;);
}

// ==================== AI ä¸»å‹•ç™¼é€è¨Šæ¯ ====================
function sendAIMessage(userId, prompt) {
  try {
    const merchantConfig = getMerchantConfig(userId);
    const systemPrompt = buildSystemPrompt(merchantConfig);
    const conversationHistory = getConversationHistory(userId, 5);
    
    let aiResponse;
    if (CONFIG.AI_PROVIDER === &#x27;openai&#x27;) {
      aiResponse = callOpenAI(systemPrompt, conversationHistory, prompt);
    } else {
      aiResponse = callClaude(systemPrompt, conversationHistory, prompt);
    }
    
    // æ¨æ’­çµ¦å®¢äºº
    pushMessage(userId, aiResponse);
    
    // è¨˜éŒ„
    logConversation(userId, `[å•†å®¶ä¸»å‹•] ${prompt}`, aiResponse, &#x27;merchant_initiated&#x27;);
    
    return `âœ… å·²ç™¼é€ AI è¨Šæ¯çµ¦å®¢äºº\n\nå…§å®¹ï¼š${aiResponse}`;
    
  } catch (error) {
    logError(&#x27;sendAIMessage&#x27;, error);
    return `âŒ ç™¼é€å¤±æ•—ï¼š${error.message}`;
  }
}

// ==================== LINE API å‡½æ•¸ ====================
function replyMessage(replyToken, message) {
  const url = &#x27;https://api.line.me/v2/bot/message/reply&#x27;;
  const payload = {
    replyToken: replyToken,
    messages: [{ type: &#x27;text&#x27;, text: message }]
  };
  
  const options = {
    method: &#x27;post&#x27;,
    headers: {
      &#x27;Content-Type&#x27;: &#x27;application/json&#x27;,
      &#x27;Authorization&#x27;: &#x27;Bearer &#x27; + CONFIG.CHANNEL_ACCESS_TOKEN
    },
    payload: JSON.stringify(payload)
  };
  
  UrlFetchApp.fetch(url, options);
}

function pushMessage(userId, message) {
  const url = &#x27;https://api.line.me/v2/bot/message/push&#x27;;
  const payload = {
    to: userId,
    messages: [{ type: &#x27;text&#x27;, text: message }]
  };
  
  const options = {
    method: &#x27;post&#x27;,
    headers: {
      &#x27;Content-Type&#x27;: &#x27;application/json&#x27;,
      &#x27;Authorization&#x27;: &#x27;Bearer &#x27; + CONFIG.CHANNEL_ACCESS_TOKEN
    },
    payload: JSON.stringify(payload)
  };
  
  UrlFetchApp.fetch(url, options);
}

function notifyCustomer(userId, message) {
  pushMessage(userId, message);
}

function notifyMerchant(message) {
  // æ¨æ’­çµ¦æ‰€æœ‰å•†å®¶ç®¡ç†å“¡
  CONFIG.ADMIN_USERS.forEach(adminId =&gt; {
    pushMessage(adminId, message);
  });
}

// ==================== å•†å®¶æŒ‡ä»¤èªªæ˜ ====================
function getMerchantCommandHelp() {
  return `ğŸ“‹ å•†å®¶æŒ‡ä»¤åˆ—è¡¨\n\n` +
         `ã€AI æ§åˆ¶ã€‘\n` +
         `/aiç‹€æ…‹ [User ID]\næŸ¥è©¢å®¢äººçš„ AI ç‹€æ…‹\n\n` +
         `/aié—œé–‰ [User ID] [åˆ†é˜]\né—œé–‰å®¢äººçš„ AIï¼ˆé è¨­ ${CONFIG.DEFAULT_AI_MUTE_MINUTES} åˆ†é˜ï¼‰\n\n` +
         `/aié–‹å•Ÿ [User ID]\né–‹å•Ÿå®¢äººçš„ AI\n\n` +
         `/aiä¸»å‹• [User ID] [è¨Šæ¯]\nè®“ AI ä¸»å‹•ç™¼é€è¨Šæ¯çµ¦å®¢äºº\n\n` +
         `/aiæ¸…å–®\nåˆ—å‡ºæ‰€æœ‰è¢«ç¦è¨€çš„å®¢äºº\n\n` +
         `ã€å…¶ä»–ã€‘\n` +
         `/help\né¡¯ç¤ºæ­¤èªªæ˜\n\n` +
         `ğŸ’¡ æç¤ºï¼šUser ID å¯å¾å°è©±è¨˜éŒ„è¡¨æŸ¥è©¢`;
}

// ==================== å·¥å…·å‡½æ•¸ ====================
function formatDateTime(date) {
  if (!date) return &#x27;&#x27;;
  const d = new Date(date);
  return Utilities.formatDate(d, &#x27;Asia/Taipei&#x27;, &#x27;yyyy-MM-dd HH:mm&#x27;);
}

function logError(functionName, error) {
  const ss = SpreadsheetApp.openById(CONFIG.SPREADSHEET_ID);
  let errorSheet = ss.getSheetByName(&#x27;éŒ¯èª¤æ—¥èªŒ&#x27;);
  
  if (!errorSheet) {
    errorSheet = ss.insertSheet(&#x27;éŒ¯èª¤æ—¥èªŒ&#x27;);
    errorSheet.appendRow([&#x27;æ™‚é–“&#x27;, &#x27;å‡½æ•¸&#x27;, &#x27;éŒ¯èª¤è¨Šæ¯&#x27;, &#x27;è©³ç´°è³‡è¨Š&#x27;]);
  }
  
  errorSheet.appendRow([
    new Date(),
    functionName,
    error.message,
    error.stack
  ]);
}

function logMerchantAction(userId, command, result) {
  const ss = SpreadsheetApp.openById(CONFIG.SPREADSHEET_ID);
  let actionSheet = ss.getSheetByName(&#x27;å•†å®¶æ“ä½œè¨˜éŒ„&#x27;);
  
  if (!actionSheet) {
    actionSheet = ss.insertSheet(&#x27;å•†å®¶æ“ä½œè¨˜éŒ„&#x27;);
    actionSheet.appendRow([&#x27;æ™‚é–“&#x27;, &#x27;User ID&#x27;, &#x27;æŒ‡ä»¤&#x27;, &#x27;çµæœ&#x27;]);
  }
  
  actionSheet.appendRow([
    new Date(),
    userId,
    command,
    result
  ]);
}

// ==================== å»ºç«‹ Sheets åˆ†é  ====================
function createMemberStatusSheet() {
  const ss = SpreadsheetApp.openById(CONFIG.SPREADSHEET_ID);
  const sheet = ss.insertSheet(&#x27;æœƒå“¡ç‹€æ…‹&#x27;);
  
  sheet.appendRow([&#x27;User ID&#x27;, &#x27;AI é–‹å•Ÿ&#x27;, &#x27;ç¦è¨€åˆ°æœŸæ™‚é–“&#x27;, &#x27;å»ºç«‹æ™‚é–“&#x27;]);
  sheet.getRange(&#x27;A1:D1&#x27;).setFontWeight(&#x27;bold&#x27;).setBackground(&#x27;#4285f4&#x27;).setFontColor(&#x27;#ffffff&#x27;);
  sheet.setFrozenRows(1);
  
  return sheet;
}

function createConversationLogSheet() {
  const ss = SpreadsheetApp.openById(CONFIG.SPREADSHEET_ID);
  const sheet = ss.insertSheet(&#x27;å°è©±ç´€éŒ„&#x27;);
  
  sheet.appendRow([&#x27;æ™‚é–“&#x27;, &#x27;User ID&#x27;, &#x27;å®¢äººè¨Šæ¯&#x27;, &#x27;AI å›è¦†&#x27;, &#x27;é¡å‹&#x27;]);
  sheet.getRange(&#x27;A1:E1&#x27;).setFontWeight(&#x27;bold&#x27;).setBackground(&#x27;#34a853&#x27;).setFontColor(&#x27;#ffffff&#x27;);
  sheet.setFrozenRows(1);
  
  return sheet;
}

// ==================== æ¸¬è©¦å‡½æ•¸ ====================
function testAIResponse() {
  const testUserId = &#x27;U1234567890abcdef&#x27;;
  const testMessage = &#x27;è«‹å•ä½ å€‘ç‡Ÿæ¥­æ™‚é–“ï¼Ÿ&#x27;;
  
  const merchantConfig = getMerchantConfig(testUserId);
  const systemPrompt = buildSystemPrompt(merchantConfig);
  
  Logger.log(&#x27;System Prompt:&#x27;);
  Logger.log(systemPrompt);
  
  const response = callOpenAI(systemPrompt, [], testMessage);
  Logger.log(&#x27;\nAI Response:&#x27;);
  Logger.log(response);
}

function testMerchantCommand() {
  const testUserId = &#x27;U1234567890abcdef&#x27;;
  
  // æ¸¬è©¦é—œé–‰ AI
  Logger.log(muteAI(testUserId, 30));
  
  // æ¸¬è©¦æŸ¥è©¢ç‹€æ…‹
  Logger.log(getAIStatusMessage(testUserId));
  
  // æ¸¬è©¦é–‹å•Ÿ AI
  Logger.log(enableAI(testUserId));
}
</code></pre>
            </div>
        </div>
    </div>
    
    <script>
        function copyCode() {
            const codeBlock = document.getElementById('codeBlock');
            const textArea = document.createElement('textarea');
            textArea.value = codeBlock.textContent;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
            
            const btn = document.querySelector('.copy-btn');
            btn.textContent = 'âœ… å·²è¤‡è£½ï¼';
            btn.classList.add('copied');
            
            setTimeout(() => {
                btn.textContent = 'ğŸ“‹ è¤‡è£½ä»£ç¢¼';
                btn.classList.remove('copied');
            }, 2000);
        }
    </script>
</body>
</html>
