<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>常見問題與故障排除 - AI 客服系統</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Microsoft JhengHei", sans-serif;
            background: #f5f7fa;
            color: #333;
            line-height: 1.8;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .back-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            text-decoration: none;
            font-size: 14px;
            transition: background 0.3s;
        }
        
        .back-btn:hover {
            background: rgba(255,255,255,0.3);
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 20px;
        }
        
        .content {
            background: white;
            border-radius: 15px;
            padding: 40px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        h1 {
            color: #667eea;
            margin-bottom: 30px;
            font-size: 36px;
            border-bottom: 3px solid #667eea;
            padding-bottom: 15px;
        }
        
        h2 {
            color: #667eea;
            margin-top: 40px;
            margin-bottom: 20px;
            font-size: 28px;
        }
        
        h3 {
            color: #555;
            margin-top: 30px;
            margin-bottom: 15px;
            font-size: 22px;
        }
        
        h4 {
            color: #666;
            margin-top: 20px;
            margin-bottom: 10px;
            font-size: 18px;
        }
        
        p {
            margin-bottom: 15px;
        }
        
        ul, ol {
            margin-left: 30px;
            margin-bottom: 20px;
        }
        
        li {
            margin-bottom: 8px;
        }
        
        code {
            background: #f4f4f4;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: "SF Mono", Monaco, Consolas, monospace;
            font-size: 14px;
            color: #e83e8c;
        }
        
        pre {
            background: #282c34;
            color: #abb2bf;
            padding: 20px;
            border-radius: 10px;
            overflow-x: auto;
            margin: 20px 0;
        }
        
        pre code {
            background: none;
            color: inherit;
            padding: 0;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        
        th, td {
            border: 1px solid #e0e0e0;
            padding: 12px;
            text-align: left;
        }
        
        th {
            background: #667eea;
            color: white;
            font-weight: 600;
        }
        
        tr:nth-child(even) {
            background: #f8f9fa;
        }
        
        blockquote {
            border-left: 4px solid #667eea;
            padding-left: 20px;
            margin: 20px 0;
            color: #666;
            font-style: italic;
        }
        
        hr {
            border: none;
            border-top: 2px solid #e0e0e0;
            margin: 30px 0;
        }
        
        .footer {
            text-align: center;
            padding: 30px;
            color: #999;
            font-size: 14px;
        }
        
        a {
            color: #667eea;
            text-decoration: none;
        }
        
        a:hover {
            text-decoration: underline;
        }
        
        .badge {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 10px;
        }
        
        .warning {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
        }
        
        .success {
            background: #d4edda;
            border-left: 4px solid #28a745;
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
        }
        
        .error {
            background: #f8d7da;
            border-left: 4px solid #dc3545;
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <div>
                <h2 style="margin: 0; font-size: 20px;">🤖 AI 客服系統</h2>
            </div>
            <a href="home.html" class="back-btn">← 返回首頁</a>
        </div>
    </div>
    
    <div class="container">
        <div class="content">
            <h1>AI 客服系統 - 常見問題與故障排除</h1>
<h2>📋 目錄</h2>
<ol>
<li><a href="#部署問題">部署問題</a></li>
<li><a href="#line-bot-問題">LINE Bot 問題</a></li>
<li><a href="#ai-回應問題">AI 回應問題</a></li>
<li><a href="#商家指令問題">商家指令問題</a></li>
<li><a href="#資料記錄問題">資料記錄問題</a></li>
<li><a href="#效能問題">效能問題</a></li>
<li><a href="#成本問題">成本問題</a></li>
<li><a href="#進階除錯">進階除錯</a></li>
</ol>
<hr />
<h2>部署問題</h2>
<h3>Q1: Apps Script 部署後 Bot 還是沒反應</h3>
<p><strong>症狀：</strong>
- LINE 傳訊息給 Bot，沒有任何回應
- Webhook 測試顯示失敗</p>
<p><strong>可能原因與解決方式：</strong></p>
<p><strong>原因 1: Webhook URL 錯誤</strong></p>
<div class="codehilite"><pre><span></span><code>✅<span class="w"> </span>解決方式：
<span class="mi">1</span>.<span class="w"> </span>檢查<span class="w"> </span><span class="nv">LINE</span><span class="w"> </span><span class="nv">Developers</span><span class="w"> </span><span class="nv">Console</span><span class="w"> </span>→<span class="w"> </span><span class="nv">Webhook</span><span class="w"> </span><span class="nv">URL</span>
<span class="mi">2</span>.<span class="w"> </span>確認格式：<span class="nv">https</span>:<span class="o">//</span><span class="nv">script</span>.<span class="nv">google</span>.<span class="nv">com</span><span class="o">/</span><span class="nv">macros</span><span class="o">/</span><span class="nv">s</span><span class="o">/</span>...<span class="o">/</span><span class="k">exec</span>
<span class="mi">3</span>.<span class="w"> </span>注意結尾必須是<span class="w"> </span><span class="o">/</span><span class="k">exec</span>（不是<span class="w"> </span><span class="o">/</span><span class="nv">dev</span>）
<span class="mi">4</span>.<span class="w"> </span>重新部署後會產生新網址，記得更新
</code></pre></div>

<p><strong>原因 2: 部署設定錯誤</strong></p>
<div class="codehilite"><pre><span></span><code>✅ 解決方式：
1. Apps Script → 部署 → 管理部署作業
2. 檢查「執行身分」= 我
3. 檢查「具有存取權的使用者」= 任何人
4. 如果設錯，編輯部署作業修正
</code></pre></div>

<p><strong>原因 3: 授權問題</strong></p>
<div class="codehilite"><pre><span></span><code>✅ 解決方式：
1. Apps Script → 執行 → 選任意函數（如 testAIResponse）
2. 會要求授權，點擊授權
3. 遇到「這個應用程式未經驗證」警告：
   → 點擊「進階」
   → 點擊「前往 XXX（不安全）」
   → 允許所有權限
4. 授權完成後重新測試
</code></pre></div>

<hr />
<h3>Q2: Webhook 測試一直失敗</h3>
<p><strong>症狀：</strong>
- LINE Developers Console → Verify 顯示 Error</p>
<p><strong>檢查清單：</strong></p>
<div class="codehilite"><pre><span></span><code>☐ Apps Script 是否已部署？
☐ Webhook URL 是否正確？
☐ Apps Script 是否已授權？
☐ doPost 函數是否存在？
☐ 部署後有沒有重啟 LINE Bot？
</code></pre></div>

<p><strong>測試方法：</strong></p>
<div class="codehilite"><pre><span></span><code><span class="mf">1.</span><span class="w"> </span><span class="n">直接用瀏覽器開啟</span><span class="w"> </span><span class="n">Webhook</span><span class="w"> </span><span class="n">URL</span>
<span class="mf">2.</span><span class="w"> </span><span class="n">應該看到</span><span class="err">：{</span><span class="s">&quot;status&quot;</span><span class="p">:</span><span class="s">&quot;error&quot;</span><span class="p">,</span><span class="mf">...</span><span class="err">}</span><span class="w"> </span><span class="n">或空白</span><span class="err">（</span><span class="n">正常</span><span class="err">）</span>
<span class="mf">3.</span><span class="w"> </span><span class="n">如果看到</span><span class="err">「</span><span class="n">需要授權</span><span class="err">」→</span><span class="w"> </span><span class="n">授權問題</span>
<span class="mf">4.</span><span class="w"> </span><span class="n">如果看到</span><span class="w"> </span><span class="mf">404</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">URL</span><span class="w"> </span><span class="n">錯誤</span>
</code></pre></div>

<hr />
<h3>Q3: 部署後修改代碼不生效</h3>
<p><strong>症狀：</strong>
- 修改了 Apps Script 代碼，但 Bot 行為沒變</p>
<p><strong>原因：</strong>
Apps Script 有快取機制，修改後需要重新部署。</p>
<p><strong>解決方式：</strong></p>
<div class="codehilite"><pre><span></span><code>✅ 方法 A - 建立新部署（推薦）
1. Apps Script → 部署 → 新增部署作業
2. 說明：v1.1（版本號遞增）
3. 點擊「部署」
4. 複製新的 URL，更新到 LINE Webhook

✅ 方法 B - 更新現有部署
1. Apps Script → 部署 → 管理部署作業
2. 點擊「鉛筆」編輯
3. 版本 → 新版本
4. 點擊「部署」
5. Webhook URL 不變
</code></pre></div>

<hr />
<h2>LINE Bot 問題</h2>
<h3>Q4: Bot 收到訊息但不回覆</h3>
<p><strong>症狀：</strong>
- 「對話紀錄」有記錄客人訊息
- 但客人沒收到回覆</p>
<p><strong>可能原因：</strong></p>
<p><strong>原因 1: Channel Access Token 錯誤</strong></p>
<div class="codehilite"><pre><span></span><code>✅ 檢查：
1. Apps Script → CONFIG.CHANNEL_ACCESS_TOKEN
2. LINE Developers → Channel Access Token（Long-lived）
3. 確認兩者完全一致

✅ 重新產生 Token：
1. LINE Developers → Messaging API → Issue
2. 複製新的 Token
3. 更新到 Apps Script
4. 重新部署
</code></pre></div>

<p><strong>原因 2: Reply Token 過期</strong></p>
<div class="codehilite"><pre><span></span><code>✅ 說明：
LINE 的 Reply Token 只能用一次，且有 1 分鐘時效。

✅ 檢查：
1. Apps Script → 執行作業
2. 看是否有「Reply token expired」錯誤
3. 如果有，代表處理太慢（&gt;1分鐘）

✅ 解決：
改用 Push Message（需消耗推播額度）
</code></pre></div>

<p><strong>原因 3: AI API 錯誤</strong></p>
<div class="codehilite"><pre><span></span><code>✅ 檢查：
1. Google Sheets → 錯誤日誌
2. 看是否有 API 相關錯誤
3. 檢查 OpenAI/Claude 帳戶餘額
4. 檢查 API Key 是否正確
</code></pre></div>

<hr />
<h3>Q5: Bot 重複回覆同一則訊息</h3>
<p><strong>症狀：</strong>
- 客人發一則訊息，收到多則相同回覆</p>
<p><strong>可能原因：</strong></p>
<p><strong>原因 1: Webhook 重複觸發</strong></p>
<div class="codehilite"><pre><span></span><code>✅ 檢查：
1. LINE Developers → Webhook settings
2. 確認只有一個 Webhook URL
3. 刪除重複的 URL
</code></pre></div>

<p><strong>原因 2: Apps Script 執行多次</strong></p>
<div class="codehilite"><pre><span></span><code>✅ 檢查：
1. Apps Script → 觸發條件
2. 刪除所有觸發條件（webhook 不需要 trigger）
3. 只保留 doPost 函數
</code></pre></div>

<hr />
<h3>Q6: Auto-reply 和 AI 衝突</h3>
<p><strong>症狀：</strong>
- 客人收到兩則回覆（LINE 官方 + AI）</p>
<p><strong>解決方式：</strong></p>
<div class="codehilite"><pre><span></span><code>✅ 關閉 LINE 官方自動回覆：
1. LINE Developers → Messaging API
2. Auto-reply messages → Disabled
3. Greeting messages → Disabled
4. 確認 Webhooks → Enabled
</code></pre></div>

<hr />
<h2>AI 回應問題</h2>
<h3>Q7: AI 回覆內容不正確或不符預期</h3>
<p><strong>症狀：</strong>
- AI 回答錯誤資訊
- AI 回答風格不對
- AI 提到「現場人員」（違反規則）</p>
<p><strong>解決方式：</strong></p>
<p><strong>步驟 1: 檢查基礎設置</strong></p>
<div class="codehilite"><pre><span></span><code>✅ Google Sheets → 基礎設置
1. 商家名稱、電話、營業時間等是否正確？
2. AI 個性是否符合預期？
3. 自訂規則是否完整？
</code></pre></div>

<p><strong>步驟 2: 優化提示詞</strong></p>
<div class="codehilite"><pre><span></span><code>✅ 修改 Apps Script → buildSystemPrompt 函數
1. 加強核心規則（例如：「絕對不可以...」）
2. 提供更多範例
3. 調整語氣描述

範例：
原本：「專業、友善」
改為：「像一個 25 歲的年輕店長，專業但不死板，會用 Emoji，語氣輕鬆但不失禮貌」
</code></pre></div>

<p><strong>步驟 3: 調整 AI 參數</strong></p>
<div class="codehilite"><pre><span></span><code>✅ Apps Script → CONFIG
AI_TEMPERATURE: 0.7 → 0.5 (更保守、更一致)
AI_MAX_TOKENS: 500 → 300 (更簡潔)
</code></pre></div>

<p><strong>步驟 4: 加入範例對話</strong></p>
<div class="codehilite"><pre><span></span><code>✅ 在 systemPrompt 加入範例：
「範例對話：
客人：請問有人在嗎？
AI：您好！我是 AI 客服小幫手，隨時為您服務 😊
客人：我想問營業時間
AI：我們營業時間是...」
</code></pre></div>

<hr />
<h3>Q8: AI 回覆太慢（超過 10 秒）</h3>
<p><strong>可能原因：</strong></p>
<p><strong>原因 1: 模型選擇</strong></p>
<div class="codehilite"><pre><span></span><code>✅ OpenAI 模型速度比較：
gpt-3.5-turbo → 最快（1-2秒）但較笨
gpt-4-turbo → 中等（3-5秒）平衡
gpt-4 → 較慢（5-10秒）但最聰明

✅ Claude 模型速度比較：
claude-3-haiku → 最快
claude-3-5-sonnet → 中等
claude-3-opus → 較慢

✅ 建議：客服場景用 gpt-4-turbo 或 claude-3-5-sonnet
</code></pre></div>

<p><strong>原因 2: 對話歷史太長</strong></p>
<div class="codehilite"><pre><span></span><code>✅ Apps Script → CONFIG
MAX_CONTEXT_MESSAGES: 10 → 5
（減少 AI 需要處理的對話數量）
</code></pre></div>

<p><strong>原因 3: 網路問題</strong></p>
<div class="codehilite"><pre><span></span><code>✅ Apps Script 超時設定：
在 UrlFetchApp.fetch 加上：
muteHttpExceptions: true,
timeout: 10  // 10 秒超時
</code></pre></div>

<hr />
<h3>Q9: AI 忘記之前的對話</h3>
<p><strong>症狀：</strong>
- 客人問：「剛才你說的價格是多少？」
- AI 回答：「請問是哪個包廂的價格？」（應該要記得）</p>
<p><strong>可能原因：</strong></p>
<p><strong>原因 1: 對話歷史沒讀取</strong></p>
<div class="codehilite"><pre><span></span><code>✅ 檢查：
1. Google Sheets → 對話紀錄
2. 確認有記錄 ai_response 類型的對話
3. Apps Script → getConversationHistory 函數
4. 確認有正確讀取並傳給 AI
</code></pre></div>

<p><strong>原因 2: 對話歷史太短</strong></p>
<div class="codehilite"><pre><span></span><code>✅ Apps Script → CONFIG
MAX_CONTEXT_MESSAGES: 5 → 10
（增加 AI 記憶的對話數量）
</code></pre></div>

<p><strong>原因 3: 類型標記錯誤</strong></p>
<div class="codehilite"><pre><span></span><code>✅ 檢查「對話紀錄」的類型欄：
<span class="k">-</span> ai_response → 會被當作歷史
<span class="k">-</span> muted, transfer_to_human → 不會被當作歷史

✅ 修改 logConversation 函數確保類型正確
</code></pre></div>

<hr />
<h3>Q10: AI 花費太高</h3>
<p><strong>症狀：</strong>
- OpenAI/Claude 每月帳單超出預算</p>
<p><strong>成本優化策略：</strong></p>
<p><strong>策略 1: 換便宜模型</strong></p>
<div class="codehilite"><pre><span></span><code>✅ OpenAI 價格比較（每 1K tokens）：
gpt-3.5-turbo: $0.0015 (輸入) / $0.002 (輸出)
gpt-4-turbo: $0.01 (輸入) / $0.03 (輸出)

💡 省錢 6-15 倍！

✅ 修改：
CONFIG.AI_MODEL = &#39;gpt-3.5-turbo&#39;
</code></pre></div>

<p><strong>策略 2: 減少 Token 用量</strong></p>
<div class="codehilite"><pre><span></span><code>✅ 方法 A - 縮短提示詞
buildSystemPrompt 函數中，移除不必要的說明

✅ 方法 B - 限制回覆長度
CONFIG.AI_MAX_TOKENS: 500 → 200

✅ 方法 C - 減少對話歷史
CONFIG.MAX_CONTEXT_MESSAGES: 10 → 5
</code></pre></div>

<p><strong>策略 3: 加入關鍵字快速回覆</strong></p>
<div class="codehilite"><pre><span></span><code><span class="err">✅</span><span class="w"> </span><span class="n">在</span><span class="w"> </span><span class="n">handleAIResponse</span><span class="w"> </span><span class="n">之前加入</span><span class="err">：</span>
<span class="k">function</span><span class="w"> </span><span class="n">quickReply</span><span class="p">(</span><span class="n">message</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">  </span><span class="n">const</span><span class="w"> </span><span class="n">keywords</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">{</span>
<span class="w">    </span><span class="s1">&#39;營業時間&#39;</span><span class="err">:</span><span class="w"> </span><span class="s1">&#39;我們營業時間是週一至週日 10:00-22:00&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="s1">&#39;wifi&#39;</span><span class="err">:</span><span class="w"> </span><span class="s1">&#39;WiFi 名稱：ONE_Guest，密碼：12345678&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="s1">&#39;價格&#39;</span><span class="err">:</span><span class="w"> </span><span class="s1">&#39;一般包廂 $200/小時...&#39;</span>
<span class="w">  </span><span class="err">}</span><span class="p">;</span>

<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">let</span><span class="w"> </span><span class="k">key</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">keywords</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">message</span><span class="p">.</span><span class="n">includes</span><span class="p">(</span><span class="k">key</span><span class="p">))</span><span class="w"> </span><span class="err">{</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">keywords</span><span class="o">[</span><span class="n">key</span><span class="o">]</span><span class="p">;</span><span class="w">  </span><span class="o">//</span><span class="w"> </span><span class="n">直接回覆</span><span class="err">，</span><span class="n">不呼叫</span><span class="w"> </span><span class="n">AI</span>
<span class="w">    </span><span class="err">}</span>
<span class="w">  </span><span class="err">}</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="k">null</span><span class="p">;</span><span class="w">  </span><span class="o">//</span><span class="w"> </span><span class="n">沒有匹配</span><span class="err">，</span><span class="n">繼續用</span><span class="w"> </span><span class="n">AI</span>
<span class="err">}</span>

<span class="err">💡</span><span class="w"> </span><span class="n">常見問題省</span><span class="w"> </span><span class="mi">100</span><span class="o">%</span><span class="w"> </span><span class="n">API</span><span class="w"> </span><span class="n">費用</span><span class="err">！</span>
</code></pre></div>

<hr />
<h2>商家指令問題</h2>
<h3>Q11: 商家指令沒反應</h3>
<p><strong>症狀：</strong>
- 商家輸入 <code>/help</code>，沒有收到回覆</p>
<p><strong>檢查清單：</strong></p>
<div class="codehilite"><pre><span></span><code>☐ 商家的 LINE User ID 有加入 CONFIG.ADMIN_USERS 嗎？
☐ 指令格式正確嗎（斜線、空格）？
☐ 「商家設定」分頁有填商家資料嗎？
☐ getUserRole 函數有正確判斷角色嗎？
</code></pre></div>

<p><strong>除錯方式：</strong></p>
<div class="codehilite"><pre><span></span><code><span class="err">✅</span><span class="w"> </span><span class="nt">在</span><span class="w"> </span><span class="nt">Apps</span><span class="w"> </span><span class="nt">Script</span><span class="w"> </span><span class="nt">加入</span><span class="w"> </span><span class="nt">Logger</span><span class="err">：</span>
<span class="nt">function</span><span class="w"> </span><span class="nt">handleMerchantCommand</span><span class="o">(</span><span class="nt">userId</span><span class="o">,</span><span class="w"> </span><span class="nt">command</span><span class="o">,</span><span class="w"> </span><span class="nt">replyToken</span><span class="o">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="err">Logger.log(&#39;User</span><span class="w"> </span><span class="n">ID</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39; + userId);</span>
<span class="s1">  Logger.log(&#39;</span><span class="n">User</span><span class="w"> </span><span class="n">Role</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39; + getUserRole(userId));</span>
<span class="s1">  Logger.log(&#39;</span><span class="n">Command</span><span class="o">:</span><span class="w"> </span><span class="err">&#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">command</span><span class="p">);</span>
<span class="w">  </span><span class="err">...</span>
<span class="p">}</span>

<span class="nt">然後查看</span><span class="w"> </span><span class="nt">Apps</span><span class="w"> </span><span class="nt">Script</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="nt">執行作業</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="nt">記錄</span>
</code></pre></div>

<hr />
<h3>Q12: <code>/ai關閉</code> 後 AI 還是會回應</h3>
<p><strong>症狀：</strong>
- 執行 <code>/ai關閉 U123... 30</code>
- 客人再發訊息，AI 還是回覆</p>
<p><strong>可能原因：</strong></p>
<p><strong>原因 1: User ID 錯誤</strong></p>
<div class="codehilite"><pre><span></span><code>✅ 確認方式：
1. Google Sheets → 會員狀態
2. 檢查該客人的 User ID 是否正確
3. 比對「對話紀錄」的 User ID
</code></pre></div>

<p><strong>原因 2: 狀態沒更新</strong></p>
<div class="codehilite"><pre><span></span><code>✅ 檢查：
1. 會員狀態 → AI 開啟欄位
2. 應該是 FALSE（不是 false 文字）
3. 如果是文字，手動改成布林值
</code></pre></div>

<p><strong>原因 3: getAIStatus 邏輯錯誤</strong></p>
<div class="codehilite"><pre><span></span><code><span class="err">✅</span><span class="w"> </span><span class="err">測試：</span>
<span class="err">在</span><span class="w"> </span><span class="n">Apps</span><span class="w"> </span><span class="n">Script</span><span class="w"> </span><span class="err">執行：</span>
<span class="n">function</span><span class="w"> </span><span class="n">testStatus</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getAIStatus</span><span class="p">(</span><span class="s1">&#39;U123...&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="n">Logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">status</span><span class="p">);</span>
<span class="p">}</span>

<span class="err">檢查</span><span class="w"> </span><span class="n">enabled</span><span class="w"> </span><span class="err">是否為</span><span class="w"> </span><span class="bp">false</span>
</code></pre></div>

<hr />
<h3>Q13: <code>/ai主動</code> 發送後客人收不到</h3>
<p><strong>可能原因：</strong></p>
<p><strong>原因 1: Push 額度用完</strong></p>
<div class="codehilite"><pre><span></span><code>✅ 檢查：
LINE Developers → Statistics → Push messages
每月免費 500 則，超過要付費

✅ 解決：
等下個月或升級付費方案
</code></pre></div>

<p><strong>原因 2: Channel Access Token 錯誤</strong></p>
<div class="codehilite"><pre><span></span><code>同 Q4 的檢查方式
</code></pre></div>

<hr />
<h2>資料記錄問題</h2>
<h3>Q14: 對話沒有記錄到 Google Sheets</h3>
<p><strong>症狀：</strong>
- Bot 有回覆，但「對話紀錄」分頁是空的</p>
<p><strong>可能原因：</strong></p>
<p><strong>原因 1: 分頁名稱錯誤</strong></p>
<div class="codehilite"><pre><span></span><code>✅ 必須完全一致：
正確：「對話紀錄」
錯誤：「對話記錄」「对话纪录」「對話紀錄 」（多空格）
</code></pre></div>

<p><strong>原因 2: 欄位結構錯誤</strong></p>
<div class="codehilite"><pre><span></span><code>✅ 第一列必須是：
時間 | User ID | 客人訊息 | AI 回覆 | 類型

✅ 重新建立分頁：
執行 createConversationLogSheet() 函數
</code></pre></div>

<p><strong>原因 3: 權限問題</strong></p>
<div class="codehilite"><pre><span></span><code>✅ 檢查：
Apps Script 是否有 Sheets 寫入權限？

✅ 重新授權：
Apps Script → 執行任意函數 → 重新授權
</code></pre></div>

<hr />
<h3>Q15: 「會員狀態」沒有自動建立</h3>
<p><strong>症狀：</strong>
- 客人發訊息，但「會員狀態」分頁沒有新增記錄</p>
<p><strong>解決方式：</strong></p>
<div class="codehilite"><pre><span></span><code>✅ 手動建立分頁：
執行 Apps Script 函數：
createMemberStatusSheet()

✅ 或手動建立：
新增分頁「會員狀態」
第一列：User ID | AI 開啟 | 禁言到期時間 | 建立時間
</code></pre></div>

<hr />
<h2>效能問題</h2>
<h3>Q16: Apps Script 配額用完</h3>
<p><strong>症狀：</strong>
- Bot 突然停止運作
- Apps Script 顯示「超過配額」</p>
<p><strong>說明：</strong></p>
<div class="codehilite"><pre><span></span><code>Apps Script 免費配額：
- 每日觸發執行時間：90 分鐘
- 每日 UrlFetchApp 呼叫：20,000 次
- 每日 Email：100 封
</code></pre></div>

<p><strong>解決方式：</strong></p>
<div class="codehilite"><pre><span></span><code>✅ 短期：
等到隔天 UTC+8 00:00 配額重置

✅ 長期：
1. 優化代碼（減少不必要的 API 呼叫）
2. 快取常用回覆
3. 升級到 Google Workspace（配額更高）
</code></pre></div>

<hr />
<h3>Q17: Google Sheets 變很慢</h3>
<p><strong>症狀：</strong>
- 對話紀錄超過 10,000 列
- 開啟 Sheets 很慢</p>
<p><strong>解決方式：</strong></p>
<div class="codehilite"><pre><span></span><code><span class="err">✅</span><span class="w"> </span><span class="err">每月歸檔：</span>
<span class="mf">1.</span><span class="w"> </span><span class="err">複製「對話紀錄」分頁</span>
<span class="mf">2.</span><span class="w"> </span><span class="err">重新命名：「對話紀錄</span><span class="n">_2026</span><span class="o">-</span><span class="mi">02</span><span class="err">」</span>
<span class="mf">3.</span><span class="w"> </span><span class="err">清空原「對話紀錄」分頁（保留標題列）</span>
<span class="mf">4.</span><span class="w"> </span><span class="err">重複執行每個月</span>

<span class="err">✅</span><span class="w"> </span><span class="err">自動歸檔腳本：</span>
<span class="n">function</span><span class="w"> </span><span class="n">archiveConversations</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="n">ss</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SpreadsheetApp</span><span class="o">.</span><span class="n">openById</span><span class="p">(</span><span class="n">CONFIG</span><span class="o">.</span><span class="n">SPREADSHEET_ID</span><span class="p">);</span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="n">logSheet</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ss</span><span class="o">.</span><span class="n">getSheetByName</span><span class="p">(</span><span class="s1">&#39;對話紀錄&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">logSheet</span><span class="o">.</span><span class="n">getDataRange</span><span class="p">()</span><span class="o">.</span><span class="n">getValues</span><span class="p">();</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">length</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">10000</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="o">//</span><span class="w"> </span><span class="err">複製到新分頁</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">today</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">Date</span><span class="p">();</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">monthName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Utilities</span><span class="o">.</span><span class="n">formatDate</span><span class="p">(</span><span class="n">today</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Asia/Taipei&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;yyyy-MM&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">archiveSheet</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">logSheet</span><span class="o">.</span><span class="n">copyTo</span><span class="p">(</span><span class="n">ss</span><span class="p">);</span>
<span class="w">    </span><span class="n">archiveSheet</span><span class="o">.</span><span class="n">setName</span><span class="p">(</span><span class="s1">&#39;對話紀錄_&#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">monthName</span><span class="p">);</span>

<span class="w">    </span><span class="o">//</span><span class="w"> </span><span class="err">清空原分頁（保留標題）</span>
<span class="w">    </span><span class="n">logSheet</span><span class="o">.</span><span class="n">getRange</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">logSheet</span><span class="o">.</span><span class="n">getLastRow</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">logSheet</span><span class="o">.</span><span class="n">getLastColumn</span><span class="p">())</span><span class="o">.</span><span class="n">clearContent</span><span class="p">();</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="o">//</span><span class="w"> </span><span class="err">設定每月</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="err">號自動執行</span>
</code></pre></div>

<hr />
<h2>成本問題</h2>
<h3>Q18: 如何監控 API 使用量？</h3>
<p><strong>OpenAI 監控：</strong></p>
<div class="codehilite"><pre><span></span><code>✅ Dashboard：
https://platform.openai.com/usage

✅ 設定預算警告：
Settings → Billing → Usage limits
設定 $50/month 警告
</code></pre></div>

<p><strong>Claude 監控：</strong></p>
<div class="codehilite"><pre><span></span><code>✅ Console：
https://console.anthropic.com/settings/billing

✅ API 使用記錄：
Dashboard → Usage
</code></pre></div>

<p><strong>LINE 監控：</strong></p>
<div class="codehilite"><pre><span></span><code>✅ 推播用量：
LINE Developers → Statistics → Push messages

✅ 免費額度：500 則/月
</code></pre></div>

<hr />
<h3>Q19: 如何降低成本？</h3>
<p><strong>綜合優化方案：</strong></p>
<div class="codehilite"><pre><span></span><code><span class="mf">1</span><span class="err">️⃣</span><span class="w"> </span><span class="n">換便宜</span><span class="w"> </span><span class="n">AI</span><span class="w"> </span><span class="n">模型</span>
<span class="n">GPT</span><span class="o">-</span><span class="mf">4</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">GPT</span><span class="o">-</span><span class="mf">3.5</span><span class="w"> </span><span class="p">(</span><span class="n">省</span><span class="w"> </span><span class="mf">85</span><span class="err">%</span><span class="p">)</span>
<span class="n">Claude</span><span class="w"> </span><span class="n">Opus</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">Haiku</span><span class="w"> </span><span class="p">(</span><span class="n">省</span><span class="w"> </span><span class="mf">70</span><span class="err">%</span><span class="p">)</span>

<span class="mf">2</span><span class="err">️⃣</span><span class="w"> </span><span class="n">加入關鍵字快速回覆</span>
<span class="n">常見問題直接回覆</span><span class="err">，</span><span class="n">不呼叫</span><span class="w"> </span><span class="n">AI</span><span class="err">（</span><span class="n">省</span><span class="w"> </span><span class="mf">100</span><span class="err">%）</span>

<span class="mf">3</span><span class="err">️⃣</span><span class="w"> </span><span class="n">減少</span><span class="w"> </span><span class="kr">To</span><span class="n">ken</span><span class="w"> </span><span class="n">用量</span>
<span class="o">-</span><span class="w"> </span><span class="n">縮短</span><span class="w"> </span><span class="kr">Sys</span><span class="n">tem</span><span class="w"> </span><span class="n">Prompt</span>
<span class="o">-</span><span class="w"> </span><span class="n">限制回覆長度</span>
<span class="o">-</span><span class="w"> </span><span class="n">減少對話歷史</span>

<span class="mf">4</span><span class="err">️⃣</span><span class="w"> </span><span class="n">優化</span><span class="w"> </span><span class="n">LINE</span><span class="w"> </span><span class="n">推播</span>
<span class="o">-</span><span class="w"> </span><span class="n">用</span><span class="w"> </span><span class="n">Reply</span><span class="w"> </span><span class="n">代替</span><span class="w"> </span><span class="n">Push</span><span class="err">（</span><span class="n">免費</span><span class="err">）</span>
<span class="o">-</span><span class="w"> </span><span class="n">減少商家主動發送</span>

<span class="mf">5</span><span class="err">️⃣</span><span class="w"> </span><span class="n">批次處理</span><span class="err">（</span><span class="n">進階</span><span class="err">）</span>
<span class="o">-</span><span class="w"> </span><span class="n">累積多個問題一次呼叫</span><span class="w"> </span><span class="n">AI</span>
<span class="o">-</span><span class="w"> </span><span class="n">使用</span><span class="w"> </span><span class="n">Batch</span><span class="w"> </span><span class="n">API</span><span class="err">（</span><span class="kr">Open</span><span class="n">AI</span><span class="err">）</span>

<span class="err">💡</span><span class="w"> </span><span class="n">預期省</span><span class="w"> </span><span class="mf">60</span><span class="o">-</span><span class="mf">80</span><span class="err">%</span><span class="w"> </span><span class="n">成本</span>
</code></pre></div>

<hr />
<h2>進階除錯</h2>
<h3>Q20: 如何查看詳細錯誤訊息？</h3>
<p><strong>方法 1: Apps Script 記錄</strong></p>
<div class="codehilite"><pre><span></span><code><span class="err">✅</span><span class="w"> </span><span class="err">在關鍵位置加入</span><span class="w"> </span><span class="n">Logger</span><span class="err">：</span>
<span class="n">Logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;變數值: &#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">variable</span><span class="p">);</span>
<span class="n">Logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">JSON</span><span class="o">.</span><span class="n">stringify</span><span class="p">(</span><span class="n">object</span><span class="p">,</span><span class="w"> </span><span class="nb nb-Type">null</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">));</span>

<span class="err">✅</span><span class="w"> </span><span class="err">查看記錄：</span>
<span class="n">Apps</span><span class="w"> </span><span class="n">Script</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="err">執行作業</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="err">選擇執行項目</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="err">記錄</span>
</code></pre></div>

<p><strong>方法 2: 錯誤日誌分頁</strong></p>
<div class="codehilite"><pre><span></span><code>✅ 檢查：
Google Sheets → 錯誤日誌
最新錯誤會自動記錄
</code></pre></div>

<p><strong>方法 3: LINE Webhook 記錄</strong></p>
<div class="codehilite"><pre><span></span><code>✅ 檢查：
LINE Developers → Messaging API → Webhook
查看最近的 Request/Response
</code></pre></div>

<hr />
<h3>Q21: 如何測試特定功能？</h3>
<p><strong>建立測試函數：</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1">// 測試 AI 回應</span>
<span class="kd">function</span><span class="w"> </span><span class="nx">testAIResponse</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">testUserId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;U1234567890&#39;</span><span class="p">;</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">testMessage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;請問營業時間？&#39;</span><span class="p">;</span>

<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">merchantConfig</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">getMerchantConfig</span><span class="p">(</span><span class="nx">testUserId</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">systemPrompt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">buildSystemPrompt</span><span class="p">(</span><span class="nx">merchantConfig</span><span class="p">);</span>

<span class="w">  </span><span class="nx">Logger</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;=== System Prompt ===&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="nx">Logger</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">systemPrompt</span><span class="p">);</span>

<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">callOpenAI</span><span class="p">(</span><span class="nx">systemPrompt</span><span class="p">,</span><span class="w"> </span><span class="p">[],</span><span class="w"> </span><span class="nx">testMessage</span><span class="p">);</span>
<span class="w">  </span><span class="nx">Logger</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;\n=== AI Response ===&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="nx">Logger</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">response</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// 測試商家指令</span>
<span class="kd">function</span><span class="w"> </span><span class="nx">testMerchantCommand</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">testUserId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Ufc463cd...&#39;</span><span class="p">;</span><span class="w">  </span><span class="c1">// 你的 User ID</span>

<span class="w">  </span><span class="nx">Logger</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">muteAI</span><span class="p">(</span><span class="nx">testUserId</span><span class="p">,</span><span class="w"> </span><span class="mf">30</span><span class="p">));</span>
<span class="w">  </span><span class="nx">Logger</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">getAIStatusMessage</span><span class="p">(</span><span class="nx">testUserId</span><span class="p">));</span>
<span class="w">  </span><span class="nx">Logger</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">enableAI</span><span class="p">(</span><span class="nx">testUserId</span><span class="p">));</span>
<span class="p">}</span>

<span class="c1">// 測試權限</span>
<span class="kd">function</span><span class="w"> </span><span class="nx">testPermission</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">userId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;U123...&#39;</span><span class="p">;</span>
<span class="w">  </span><span class="nx">Logger</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Role: &#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">getUserRole</span><span class="p">(</span><span class="nx">userId</span><span class="p">));</span>
<span class="p">}</span>

<span class="c1">// 測試對話歷史</span>
<span class="kd">function</span><span class="w"> </span><span class="nx">testHistory</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">userId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;U123...&#39;</span><span class="p">;</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">history</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">getConversationHistory</span><span class="p">(</span><span class="nx">userId</span><span class="p">,</span><span class="w"> </span><span class="mf">5</span><span class="p">);</span>
<span class="w">  </span><span class="nx">Logger</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">history</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="mf">2</span><span class="p">));</span>
<span class="p">}</span>
</code></pre></div>

<hr />
<h3>Q22: 如何重置整個系統？</h3>
<p><strong>完整重置步驟：</strong></p>
<div class="codehilite"><pre><span></span><code>⚠️ 警告：這會清除所有資料！

1️⃣ 備份資料
- 下載 Google Sheets（檔案 → 下載）
- 複製 Apps Script 代碼

2️⃣ 清空資料
- 刪除「會員狀態」所有資料（保留標題）
- 刪除「對話紀錄」所有資料（保留標題）
- 刪除「商家操作記錄」所有資料（保留標題）
- 刪除「錯誤日誌」所有資料（保留標題）

3️⃣ 重新設定
- 填寫「基礎設置」
- 填寫「商家設定」
- 更新 Apps Script CONFIG

4️⃣ 重新部署
- Apps Script → 部署 → 新增部署作業
- 更新 LINE Webhook URL

5️⃣ 測試
- 執行完整測試清單
</code></pre></div>

<hr />
<h2>🆘 緊急救援</h2>
<h3>系統完全掛掉怎麼辦？</h3>
<p><strong>快速診斷流程：</strong></p>
<div class="codehilite"><pre><span></span><code>第 1 步：確認 LINE Bot 狀態
→ 傳訊息給 Bot
→ 有回應？ → 跳到第 3 步
→ 沒回應？ → 繼續第 2 步

第 2 步：檢查 Webhook
→ LINE Developers → Verify
→ Success？ → 跳到第 3 步
→ Failed？ → 檢查 Apps Script 部署、URL

第 3 步：檢查 Apps Script 執行記錄
→ Apps Script → 執行作業
→ 有錯誤？ → 查看錯誤訊息
→ 沒執行？ → Webhook 沒觸發

第 4 步：檢查 API 狀態
→ OpenAI/Claude Dashboard
→ 餘額足夠？
→ API Key 有效？

第 5 步：檢查 Google Sheets
→ 分頁名稱正確？
→ 權限正確？

第 6 步：還是不行？
→ 重新部署（新部署作業）
→ 重新授權（執行測試函數）
→ 重啟 LINE Bot（關閉再開啟 Webhook）
</code></pre></div>

<hr />
<h2>📞 取得協助</h2>
<h3>官方文件</h3>
<ul>
<li><strong>LINE Developers</strong>: https://developers.line.biz/</li>
<li><strong>OpenAI API</strong>: https://platform.openai.com/docs</li>
<li><strong>Claude API</strong>: https://docs.anthropic.com/</li>
<li><strong>Apps Script</strong>: https://developers.google.com/apps-script</li>
</ul>
<h3>社群支援</h3>
<ul>
<li><strong>LINE Bot 討論區</strong>: LINE Developers Community</li>
<li><strong>OpenAI 論壇</strong>: community.openai.com</li>
<li><strong>Stack Overflow</strong>: 搜尋相關錯誤訊息</li>
</ul>
<hr />
<p><strong>如果以上都無法解決，請聯繫系統開發者並提供：</strong>
1. 錯誤訊息截圖
2. Apps Script 執行記錄
3. Google Sheets 錯誤日誌
4. 操作步驟描述</p>
<p>我會盡快協助您解決問題！💪</p>
        </div>
    </div>
    
    <div class="footer">
        <p>© 2026 ONE桌遊 AI 客服系統 | 版本 v3.0</p>
    </div>
</body>
</html>
